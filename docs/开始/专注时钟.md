---
title: ä¸“æ³¨æ—¶é’Ÿ
icon: lucide/alarm-clock
hide:
  - navigation
  - toc
  - footer
---

<!-- å…¨å±åº”ç”¨å®¹å™¨ -->
<div id="focus-app" class="focus-app-wrapper theme-pomodoro">
  
  <div class="focus-card">
    <!-- é¡¶éƒ¨æ¨¡å¼åˆ‡æ¢ -->
    <div class="mode-tabs">
      <button class="tab-item active" onclick="app.switchMode('pomodoro')">ğŸ… ç•ªèŒ„ä¸“æ³¨</button>
      <button class="tab-item" onclick="app.switchMode('custom')">â³ è‡ªå®šä¹‰å€’è®¡æ—¶</button>
      <button class="tab-item" onclick="app.switchMode('stopwatch')">â±ï¸ æ­£å‘è®¡æ—¶</button>
    </div>

    <!-- æ ¸å¿ƒæ˜¾ç¤ºåŒº -->
    <div class="display-area">
      
      <!-- 1. çº¯æ•°å­—æ˜¾ç¤º -->
      <div id="static-display" class="big-digits">25:00</div>

      <!-- 2. è¾“å…¥æ§ä»¶ -->
      <div id="custom-inputs" class="input-group" style="display:none;">
        <div class="input-wrapper">
          <input type="number" id="in-hrs" placeholder="00" min="0" max="99">
          <span class="label">æ—¶</span>
        </div>
        <span class="colon">:</span>
        <div class="input-wrapper">
          <input type="number" id="in-mins" placeholder="00" min="0" max="59">
          <span class="label">åˆ†</span>
        </div>
        <span class="colon">:</span>
        <div class="input-wrapper">
          <input type="number" id="in-secs" placeholder="00" min="0" max="59">
          <span class="label">ç§’</span>
        </div>
      </div>
      
      <!-- çŠ¶æ€æç¤º -->
      <div id="status-text" class="status-label">å‡†å¤‡å°±ç»ª</div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
    <div class="control-bar">
      <button id="main-btn" class="btn-primary" onclick="app.toggleTimer()">å¼€å§‹è®¡æ—¶</button>
      <button id="reset-btn" class="btn-icon" onclick="app.resetTimer()" title="é‡ç½®">
        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
          <path d="M3 3v5h5"></path>
        </svg>
      </button>
    </div>

    <!-- ç•ªèŒ„é’Ÿä¸“å±å¿«æ·æŒ‰é’® -->
    <div id="pomo-shortcuts" class="shortcuts">
      <button onclick="app.setPomoTime(60)">60 åˆ†é’Ÿ</button>
      <button onclick="app.setPomoTime(25)">30 åˆ†é’Ÿ</button>
      <button onclick="app.setPomoTime(15)">15 åˆ†é’Ÿ</button>
      <button onclick="app.setPomoTime(5)">5 åˆ†é’Ÿ</button>
    </div>
  </div>
  
  <!-- åº•éƒ¨ä»»åŠ¡æ  -->
  <div class="task-section">
    <input type="text" class="task-input" placeholder="âœ¨ æ­¤æ—¶æ­¤åˆ»ï¼Œä½ çš„ç›®æ ‡æ˜¯..." />
  </div>

  <!-- ã€æ–°å¢ã€‘Toast æ¶ˆæ¯å®¹å™¨ -->
  <div id="toast-container" class="toast-container"></div>

  <!-- ã€æ–°å¢ã€‘è‡ªå®šä¹‰æ¨¡æ€æ¡† (Confirm/Alert) -->
  <div id="custom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
      <h3 id="modal-title" class="modal-title">æç¤º</h3>
      <p id="modal-msg" class="modal-msg">å†…å®¹æ–‡æœ¬</p>
      <div class="modal-actions">
        <button id="modal-cancel-btn" class="modal-btn cancel">å–æ¶ˆ</button>
        <button id="modal-confirm-btn" class="modal-btn confirm">ç¡®å®š</button>
      </div>
    </div>
  </div>

</div>

<!-- æç¤ºéŸ³ -->
<audio id="sound-alarm"><source src="https://downsc.chinaz.net/Files/DownLoad/sound1/202505/xm3669.mp3" type="audio/mpeg"></audio>

<style>
/* --- å…¨å±€é‡ç½®ä¸å¸ƒå±€ --- */
.md-content__inner, .md-main__inner { margin: 0; padding: 0; max-width: none; }
header.md-header { display: none; }

:root {
  --theme-pomo: #d95550;
  --theme-custom: #785ebb;
  --theme-stop: #4c9195;
  --bg-current: var(--theme-pomo);
}

.focus-app-wrapper {
  position: fixed;
  top: 0; left: 0; width: 100%; 
  /* é€‚é…ç§»åŠ¨ç«¯ï¼šä½¿ç”¨ dvh é¿å…åœ°å€æ é®æŒ¡ï¼Œå›é€€å…¼å®¹ vh */
  height: 100vh; height: 100dvh;
  background-color: var(--bg-current);
  z-index: 9999;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  font-family: "Nunito", "PingFang SC", "Microsoft YaHei", sans-serif;
  color: white;
  transition: background-color 0.5s ease;
  /* é˜²æ­¢ç§»åŠ¨ç«¯æ¨ªå‘æº¢å‡º */
  overflow: hidden;
}

/* --- å¡ç‰‡æ ·å¼ --- */
.focus-card {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 40px;
  border-radius: 24px;
  width: 90%; max-width: 500px;
  /* ç§»åŠ¨ç«¯æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œé˜²æ­¢å†…å®¹è¢«é”®ç›˜é¡¶å‡º */
  max-height: 90dvh;
  overflow-y: auto;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  border: 1px solid rgba(255,255,255,0.1);
  position: relative;
  z-index: 10;
  /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
  scrollbar-width: none; 
}
.focus-card::-webkit-scrollbar { display: none; }

/* --- é¡¶éƒ¨ Tab --- */
.mode-tabs {
  display: flex; justify-content: center; align-items: center; gap: 5px;
  margin-bottom: 30px;
  background: rgba(0,0,0,0.1);
  padding: 4px; border-radius: 50px;
  width: fit-content; max-width: 100%;
  margin-left: auto; margin-right: auto;
  flex-wrap: wrap; /* å…è®¸æå°å±å¹•æ¢è¡Œï¼Œæˆ–ç”±åª’ä½“æŸ¥è¯¢æ§åˆ¶ */
}
.tab-item {
  background: none; border: none; color: rgba(255,255,255,0.7);
  padding: 8px 16px; border-radius: 20px; cursor: pointer;
  font-size: 14px; font-weight: bold; transition: all 0.2s;
  white-space: nowrap;
}
.tab-item.active {
  background: white; color: var(--bg-current); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* --- æ˜¾ç¤ºåŒºåŸŸ --- */
.display-area { 
  min-height: 120px; 
  display: flex; flex-direction: column; 
  justify-content: center; align-items: center; 
  margin-bottom: 20px; 
}

.big-digits {
  /* ä½¿ç”¨ clamp å®ç°å­—ä½“å¤§å°éšè§†å£å¹³æ»‘ç¼©æ”¾ */
  font-size: clamp(60px, 18vw, 100px);
  font-weight: 700; line-height: 1;
  font-variant-numeric: tabular-nums; letter-spacing: 2px;
  text-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.status-label {
  margin-top: 10px; font-size: 16px; opacity: 0.8; letter-spacing: 1px; font-weight: 300;
}

/* --- è¾“å…¥æ¡† (ç§»åŠ¨ç«¯é‡ç‚¹é€‚é…å¯¹è±¡) --- */
.input-group { display: flex; align-items: center; justify-content: center; gap: 4px; }
.input-wrapper { display: flex; flex-direction: column; align-items: center; }
.input-group input {
  background: rgba(255,255,255,0.15); border: 2px solid transparent;
  border-radius: 12px; color: white;
  /* å“åº”å¼å®½é«˜ */
  width: clamp(50px, 16vw, 80px); 
  height: clamp(50px, 16vw, 80px);
  font-size: clamp(24px, 8vw, 40px);
  text-align: center; outline: none;
  transition: all 0.2s;
  padding: 0;
}
.input-group input:focus { background: white; color: var(--bg-current); }
.input-group input::-webkit-outer-spin-button,
.input-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.input-group .label { font-size: 12px; margin-top: 5px; opacity: 0.7; }
.input-group .colon { 
  font-size: clamp(20px, 6vw, 40px); 
  font-weight: bold; 
  margin-bottom: 20px; 
  padding: 0 2px;
}

/* --- æŒ‰é’® --- */
.control-bar { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
.btn-primary {
  background: white; color: var(--bg-current);
  border: none; padding: 18px 0; /* å·¦å³paddingç”±å®½åº¦æ§åˆ¶ */
  width: 180px; max-width: 50vw; /* é˜²æ­¢æŒ‰é’®è¿‡å®½ */
  font-size: 20px; font-weight: bold;
  border-radius: 16px; cursor: pointer; text-transform: uppercase;
  box-shadow: 0 6px 0 rgba(230,230,230,1);
  transition: transform 0.1s, box-shadow 0.1s, color 0.3s;
  display: flex; justify-content: center; align-items: center;
}
.btn-primary:active { transform: translateY(6px); box-shadow: none; }
.btn-icon {
  background: rgba(255,255,255,0.2); border: none;
  width: 50px; height: 50px; flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
  border-radius: 50%;
  color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.btn-icon:hover { background: rgba(255,255,255,0.4); }

.shortcuts { display: flex; gap: 8px; justify-content: center; height: 30px; flex-wrap: wrap; }
.shortcuts button {
  background: none; border: 1px solid rgba(255,255,255,0.3);
  color: white; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 13px;
  transition: background 0.2s;
}

.task-section { margin-top: 30px; width: 100%; text-align: center; z-index: 10; }
.task-input {
  background: transparent; border: none; border-bottom: 2px solid rgba(255,255,255,0.3);
  width: 100%; max-width: 300px;
  color: white; font-size: 16px; /* 16pxé¿å…iOSè¾“å…¥æ¡†è‡ªåŠ¨æ”¾å¤§ */
  text-align: center; padding: 8px;
  outline: none; transition: border 0.3s;
}

/* --- Toast æ ·å¼ --- */
.toast-container {
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
  width: 90%; pointer-events: none; z-index: 10001;
  display: flex; flex-direction: column; align-items: center; gap: 10px;
}
.toast {
  background: rgba(255, 255, 255, 0.95); color: #333;
  padding: 10px 20px; border-radius: 50px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-weight: 600; font-size: 13px;
  text-align: center;
}

/* --- Modal æ ·å¼ --- */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
  z-index: 10000;
  display: flex; justify-content: center; align-items: center;
}
.modal-box {
  background: white; color: #333;
  width: 80%; max-width: 300px;
  border-radius: 20px; padding: 20px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.modal-btn { padding: 12px 0; font-size: 14px; border-radius: 12px; }

/* --- ä¿®å¤ Modal æŒ‰é’®å¸ƒå±€ --- */
.modal-actions {
  display: flex;       /* å¯ç”¨ Flex å¸ƒå±€ */
  gap: 15px;           /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
  margin-top: 20px;    /* ä¸ä¸Šæ–¹æ–‡å­—çš„è·ç¦» */
  width: 100%;
}

.modal-btn {
  flex: 1;             /* è®©ä¸¤ä¸ªæŒ‰é’®å¹³åˆ†å®½åº¦ */
  padding: 12px 0;
  font-size: 15px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: opacity 0.2s;
}

.modal-btn:active {
  transform: scale(0.98);
}

/* å–æ¶ˆæŒ‰é’®ä¸“ç”¨æ ·å¼ï¼ˆç°è‰²èƒŒæ™¯ï¼‰ */
.modal-btn.cancel {
  background-color: #f0f0f0;
  color: #666;
}

/* ç¡®å®šæŒ‰é’®æ ·å¼ï¼ˆé¢œè‰²åœ¨ JS ä¸­åŠ¨æ€è®¾ç½®ï¼Œè¿™é‡Œè®¾ç½®åŸºç¡€æ–‡å­—é¢œè‰²ï¼‰ */
.modal-btn.confirm {
  color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* --- è¡¥å……ç¼ºå¤±çš„åŠ¨ç”»å…³é”®å¸§ --- */
@keyframes toastIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-20px); }
}

/* ç¡®ä¿ Toast åˆšå‡ºç°æ—¶ä¹Ÿæœ‰åŠ¨ç”» */
.toast {
  /* åŸæœ‰çš„æ ·å¼ä¿æŒä¸å˜ */
  background: rgba(255, 255, 255, 0.95); color: #333;
  padding: 10px 20px; border-radius: 50px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-weight: 600; font-size: 13px;
  text-align: center;
  /* æ–°å¢ï¼šå…¥åœºåŠ¨ç”» */
  animation: toastIn 0.3s forwards;
}

/* --- ç§»åŠ¨ç«¯ä¸“é¡¹åª’ä½“æŸ¥è¯¢ --- */
@media (max-width: 600px) {
  .focus-card {
    padding: 24px 16px; /* å‡å°‘å¡ç‰‡å†…è¾¹è· */
    width: 92%;
  }

  /* é¡¶éƒ¨ Tab æ›´åŠ ç´§å‡‘ */
  .mode-tabs { gap: 2px; width: 100%; justify-content: space-between; }
  .tab-item { 
    padding: 8px 0; 
    flex: 1; /* å‡åˆ†å®½åº¦ */
    font-size: 12px; 
    text-align: center;
  }
  
  /* åœ¨è¶…çª„å±å¹•ä¸Šéšè—Tabæ–‡å­—ä¸­çš„Emojiæˆ–ç®€åŒ–æ–‡æœ¬(å¯é€‰) */
  
  /* è¾“å…¥åŒºåŸŸæ›´ç´§å‡‘ */
  .input-group { gap: 2px; }
  .input-group .label { font-size: 10px; }
  
  /* æŒ‰é’®è°ƒæ•´ */
  .btn-primary { font-size: 18px; padding: 15px 0; min-width: auto; flex: 1; }
  .btn-icon { width: 44px; height: 44px; }
  
  /* å¿«æ·æŒ‰é’®æŠ˜è¡Œ */
  .shortcuts { height: auto; margin-bottom: 10px; }
  .shortcuts button { padding: 4px 10px; font-size: 12px; }
  
  .task-section { margin-top: 20px; }
}

/* é’ˆå¯¹é«˜åº¦å¾ˆå°çš„å±å¹•ï¼ˆæ¨ªå±æ¨¡å¼ï¼‰ */
@media (max-height: 500px) {
  .focus-card { padding: 10px 20px; display: flex; flex-direction: row; align-items: center; gap: 20px; width: 95%; max-width: 700px; }
  .display-area { margin-bottom: 0; min-height: auto; }
  .big-digits { font-size: 60px; }
  .mode-tabs { display: none; /* æ¨ªå±æ—¶ä¸ºäº†ç©ºé—´å¯èƒ½éœ€è¦éšè—éæ ¸å¿ƒå…ƒç´  */ }
  .task-section { display: none; }
  .control-bar { margin-bottom: 0; }
}
</style>

<script>
window.app = (function() {
  // çŠ¶æ€å˜é‡
  let state = {
    mode: 'pomodoro', 
    isRunning: false,
    intervalId: null,
    totalSeconds: 25 * 60,
    elapsedSeconds: 0 
  };
  
  const modes = {
    pomodoro: { color: 'var(--theme-pomo)', label: 'ä¸“æ³¨ä¸­', default: 25 * 60 },
    custom:   { color: 'var(--theme-custom)', label: 'å€’è®¡æ—¶', default: 0 },
    stopwatch:{ color: 'var(--theme-stop)',   label: 'æ­£è®¡æ—¶', default: 0 }
  };
  
  // DOM å…ƒç´ ç¼“å­˜
  const els = {
    bg: document.documentElement,
    display: document.getElementById('static-display'),
    inputs: document.getElementById('custom-inputs'),
    mainBtn: document.getElementById('main-btn'),
    status: document.getElementById('status-text'),
    shortcuts: document.getElementById('pomo-shortcuts'),
    tabs: document.querySelectorAll('.tab-item'),
    inH: document.getElementById('in-hrs'),
    inM: document.getElementById('in-mins'),
    inS: document.getElementById('in-secs'),
    
    // ã€ä¿®æ”¹ã€‘è·å– HTML ä¸­çš„ audio æ ‡ç­¾
    audio: document.getElementById('sound-alarm'),
    
    toastContainer: document.getElementById('toast-container'),
    modal: document.getElementById('custom-modal'),
    modalTitle: document.getElementById('modal-title'),
    modalMsg: document.getElementById('modal-msg'),
    modalConfirmBtn: document.getElementById('modal-confirm-btn'),
    modalCancelBtn: document.getElementById('modal-cancel-btn')
  };

  // --- UI å·¥å…·å‡½æ•° ---
  function showToast(msg) {
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerText = msg;
    els.toastContainer.appendChild(el);

    // 2.5ç§’åå¼€å§‹æ¶ˆå¤±åŠ¨ç”»
    setTimeout(() => {
      // è§¦å‘ CSS åŠ¨ç”»
      el.style.animation = 'toastOut 0.3s forwards';
      
      // ç›‘å¬åŠ¨ç”»ç»“æŸäº‹ä»¶ç§»é™¤å…ƒç´ 
      const removeFunc = () => {
        if (el.parentNode) el.remove();
      };
      el.addEventListener('animationend', removeFunc);
      
      // ã€å…œåº•ä¿é™©ã€‘ä¸‡ä¸€åŠ¨ç”»æ²¡è§¦å‘ï¼ˆæ¯”å¦‚æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼‰ï¼Œ0.4ç§’åå¼ºåˆ¶ç§»é™¤
      setTimeout(removeFunc, 400);
    }, 1000);
  }

  function showModal(options) {
    const { title, msg, onConfirm, showCancel = true, confirmText = 'ç¡®å®š' } = options;
    
    els.modalTitle.innerText = title;
    els.modalMsg.innerText = msg;
    els.modalConfirmBtn.innerText = confirmText;
    
    els.modalConfirmBtn.style.backgroundColor = modes[state.mode].color;
    els.modalTitle.style.color = modes[state.mode].color;

    els.modalCancelBtn.style.display = showCancel ? 'block' : 'none';
    els.modal.style.display = 'flex';

    // é‡æ–°ç»‘å®šäº‹ä»¶
    const newConfirm = els.modalConfirmBtn.cloneNode(true);
    const newCancel = els.modalCancelBtn.cloneNode(true);
    els.modalConfirmBtn.replaceWith(newConfirm);
    els.modalCancelBtn.replaceWith(newCancel);
    els.modalConfirmBtn = newConfirm;
    els.modalCancelBtn = newCancel;

    els.modalConfirmBtn.onclick = () => {
      els.modal.style.display = 'none';
      if (onConfirm) onConfirm();
    };
    els.modalCancelBtn.onclick = () => {
      els.modal.style.display = 'none';
    };
  }

  // --- æ ¸å¿ƒé€»è¾‘ ---

  function switchMode(newMode) {
    if (state.isRunning) {
      showModal({
        title: "åˆ‡æ¢æ¨¡å¼?",
        msg: "åˆ‡æ¢æ¨¡å¼å°†é‡ç½®å½“å‰è®¡æ—¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ",
        onConfirm: () => {
          resetTimer();
          _executeSwitch(newMode);
        }
      });
      return;
    }
    _executeSwitch(newMode);
  }

  function _executeSwitch(newMode) {
    state.mode = newMode;
    state.elapsedSeconds = 0;
    
    els.bg.style.setProperty('--bg-current', modes[newMode].color);
    els.tabs.forEach(t => t.classList.remove('active'));
    
    const idx = ['pomodoro', 'custom', 'stopwatch'].indexOf(newMode);
    if(els.tabs[idx]) els.tabs[idx].classList.add('active');

    if (newMode === 'pomodoro') {
      showDisplayOnly();
      els.shortcuts.style.display = 'flex';
      state.totalSeconds = modes.pomodoro.default;
      updateDisplay(state.totalSeconds);
      els.status.innerText = "å‡†å¤‡ä¸“æ³¨";
    } else if (newMode === 'custom') {
      showInputsOnly();
      els.shortcuts.style.display = 'none';
      els.status.innerText = "è®¾ç½®æ—¶é—´";
    } else if (newMode === 'stopwatch') {
      showDisplayOnly();
      els.shortcuts.style.display = 'none';
      updateDisplay(0);
      els.status.innerText = "å‡†å¤‡å¼€å§‹";
    }
  }

function toggleTimer() {
    // --- 1. é¢„åŠ è½½/è§£é”éŸ³é¢‘é€»è¾‘ ---
    // åªæœ‰åœ¨â€œå¼€å§‹â€ä¸”éŸ³é¢‘å­˜åœ¨æ—¶æ‰æ‰§è¡Œ
    if (!state.isRunning && els.audio) {
      // å…ˆé™éŸ³ï¼Œé˜²æ­¢ç”¨æˆ·å¬åˆ°ä¸€ç¬é—´çš„æ‚éŸ³
      els.audio.muted = true;
      
      const playPromise = els.audio.play();

      // ç°ä»£æµè§ˆå™¨ä¸­ play() è¿”å›ä¸€ä¸ª Promise
      if (playPromise !== undefined) {
        playPromise.then(() => {
          // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ setTimeout å»¶è¿Ÿæš‚åœ
          // å»¶è¿Ÿ 50ms æš‚åœï¼Œç¡®ä¿ play() è¯·æ±‚å·²å®Œå…¨åœ¨æµè§ˆå™¨å†…éƒ¨â€œè½åœ°â€
          // è¿™æ ·å°±é¿å¼€äº† "interrupted by a call to pause" é”™è¯¯
          setTimeout(() => {
            els.audio.pause();
            els.audio.currentTime = 0;
            // å…³é”®ï¼šæ¢å¤éŸ³é‡ï¼Œå¦åˆ™å€’è®¡æ—¶ç»“æŸæ—¶æ²¡å£°éŸ³
            els.audio.muted = false; 
          }, 50);
        }).catch(error => {
          // å¦‚æœä¾ç„¶è¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆæ¯”å¦‚ç”¨æˆ·æ“ä½œè¿‡å¿«ï¼‰ï¼Œæˆ‘ä»¬è¦ç¡®ä¿éŸ³é‡è¢«æ¢å¤
          els.audio.muted = false;
          
          // ä»…å¿½ç•¥ AbortErrorï¼Œå…¶ä»–é”™è¯¯æ‰“å°å‡ºæ¥æ–¹ä¾¿è°ƒè¯•
          if (error.name !== 'AbortError') {
             console.warn("éŸ³é¢‘é¢„åŠ è½½æç¤º:", error);
          }
        });
      }
    }

    // --- 2. æ­£å¸¸çš„è®¡æ—¶å™¨å¼€å…³é€»è¾‘ ---
    state.isRunning ? pauseTimer() : startTimer();
  }

  function startTimer() {
    if (state.mode === 'custom' && els.display.style.display === 'none') {
      const h = parseInt(els.inH.value) || 0;
      const m = parseInt(els.inM.value) || 0;
      const s = parseInt(els.inS.value) || 0;
      const total = h * 3600 + m * 60 + s;
      
      if (total <= 0) {
        showToast("â³ è¯·è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„æ—¶é—´ï¼");
        return;
      }
      state.totalSeconds = total;
      showDisplayOnly();
      updateDisplay(total);
    }

    state.isRunning = true;
    els.mainBtn.innerText = "æš‚åœ";
    els.mainBtn.style.boxShadow = "none";
    els.mainBtn.style.transform = "translateY(6px)";
    els.status.innerText = modes[state.mode].label;

    state.intervalId = setInterval(tick, 1000);
  }

  function pauseTimer() {
    state.isRunning = false;
    clearInterval(state.intervalId);
    els.mainBtn.innerText = "ç»§ç»­";
    els.mainBtn.style.boxShadow = ""; 
    els.mainBtn.style.transform = "";
    els.status.innerText = "å·²æš‚åœ";
  }

  function resetTimer() {
    pauseTimer();
    els.mainBtn.innerText = "å¼€å§‹è®¡æ—¶";
    document.title = "å…¨èƒ½ä¸“æ³¨æ—¶é’Ÿ";
    
    // é‡ç½®æ—¶åœæ­¢éŸ³é¢‘æ’­æ”¾
    if (els.audio) {
      els.audio.pause();
      els.audio.currentTime = 0;
    }

    if (state.mode === 'pomodoro') {
      state.totalSeconds = modes.pomodoro.default;
      updateDisplay(state.totalSeconds);
      els.status.innerText = "å‡†å¤‡ä¸“æ³¨";
    } else if (state.mode === 'custom') {
      showInputsOnly();
      els.status.innerText = "è®¾ç½®æ—¶é—´";
    } else if (state.mode === 'stopwatch') {
      state.elapsedSeconds = 0;
      updateDisplay(0);
      els.status.innerText = "å‡†å¤‡å¼€å§‹";
    }
  }

  function tick() {
    if (state.mode === 'stopwatch') {
      state.elapsedSeconds++;
      updateDisplay(state.elapsedSeconds);
      document.title = `${formatTime(state.elapsedSeconds)} - æ­£è®¡æ—¶`;
    } else {
      if (state.totalSeconds > 0) {
        state.totalSeconds--;
        updateDisplay(state.totalSeconds);
        document.title = `${formatTime(state.totalSeconds)} - ${state.mode === 'pomodoro' ? 'ä¸“æ³¨' : 'å€’è®¡æ—¶'}`;
      } else {
        finish();
      }
    }
  }

  function finish() {
      pauseTimer();
      state.isRunning = false;
      els.mainBtn.innerText = "å®Œæˆ";
      els.status.innerText = "æ—¶é—´åˆ°ï¼";
      
      // ã€ä¿®æ”¹ã€‘éŸ³é¢‘æ’­æ”¾é€»è¾‘
      if (els.audio) {
          els.audio.currentTime = 0;
          const playPromise = els.audio.play();
          
          if (playPromise !== undefined) {
              playPromise.catch(e => {
                  // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœé”™è¯¯æ˜¯å› ä¸ºâ€œè¢«æ‰“æ–­â€(å³ç”¨æˆ·ç‚¹å‡»äº†æš‚åœ/çŸ¥é“äº†)ï¼Œåˆ™å¿½ç•¥ï¼Œä¸å¼¹çª—
                  if (e.name === 'AbortError') return;
                  
                  showToast("âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶");
                  console.error(e);
              });
          }
      }
      
      showModal({
        title: "ğŸ‰ æ—¶é—´åˆ°ï¼",
        msg: "éå¸¸æ£’ï¼ä½ åˆšåˆšå®Œæˆäº†ä¸€æ®µä¸“æ³¨æ—¶å…‰ã€‚ä¼‘æ¯ä¸€ä¸‹å§ã€‚",
        confirmText: "çŸ¥é“äº†",
        showCancel: false,
        onConfirm: () => {
            // ç‚¹å‡»ç¡®å®šååœæ­¢éŸ³ä¹
            if(els.audio) {
                // è¿™é‡Œè°ƒç”¨ pause() å¯èƒ½ä¼šè§¦å‘ä¸Šé¢ play() çš„ AbortError
                // ä½†ä¸Šé¢çš„ catch å·²ç»å¤„ç†äº†ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å®‰å…¨çš„
                els.audio.pause();
                els.audio.currentTime = 0;
            }
        }
      });
    }

  // --- è¾…åŠ©åŠŸèƒ½ ---

  function showDisplayOnly() {
    els.display.style.display = 'block';
    els.inputs.style.display = 'none';
  }

  function showInputsOnly() {
    els.display.style.display = 'none';
    els.inputs.style.display = 'flex';
  }

  function updateDisplay(seconds) {
    els.display.innerText = formatTime(seconds);
  }

  function formatTime(totalSeconds) {
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
    return `${pad(m)}:${pad(s)}`;
  }
  
  function pad(num) { return num.toString().padStart(2, '0'); }

  function setPomoTime(minutes) {
    if (state.isRunning) {
        showToast("ğŸš« è®¡æ—¶ä¸­æ— æ³•ä¿®æ”¹ï¼Œè¯·å…ˆé‡ç½®");
        return;
    }
    modes.pomodoro.default = minutes * 60;
    state.totalSeconds = minutes * 60;
    updateDisplay(state.totalSeconds);
    showToast(`âœ… å·²è®¾å®šä¸º ${minutes} åˆ†é’Ÿ`);
  }

  // åˆå§‹åŒ–
  updateDisplay(modes.pomodoro.default);

  return { switchMode, toggleTimer, resetTimer, setPomoTime };
})();
</script>